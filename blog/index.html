<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>LHG Blog</title>
    <link rel="stylesheet" href="/normalize.css" />
    <link rel="stylesheet" href="/blog.css" />
  </head>
  <body>
    <header><a href="/blog/">LuHeGi's Blog</a></header>
    <main>
      <form class="search-form" action="javascript:search();">
        <input
          class="search-txt"
          type="text"
          name="search-txt"
          placeholder="Type Here To Search"
        />
        <button class="search-btn" type="submit">Search</button>
      </form>
      <div class="search-results"></div>
      <h1>
        My Blog Posts <span class="date">click the box to go to the blog</span>
      </h1>
      <div class="post" onclick="location.pathname = 'blog/gcse/'">
        <h2>My GCSEs <span class="date">2018/12/17</span></h2>
        <p>Topics Covered:</p>
        <ul>
          <li>What I Achieved</li>
          <li>What Is A GCSE</li>
        </ul>
      </div>
      <div class="post" onclick="location.pathname = 'blog/alevel/'">
        <h2>My A levels <span class="date">2018/12/17</span></h2>
        <p>Topics Covered:</p>
        <ul>
          <li>What I Achieved</li>
          <li>What Is An A Level</li>
        </ul>
      </div>
    </main>
    <p class="footer">Copyright &copy; 2018 - Luke Gilfoyle</p>
    <script>
      let blogs = undefined;
      let txtSearch;
      let blogTemplate;
      let searchResults;
      let dp = new DOMParser();
      const isIterable = (object) =>
        object != null && typeof object[Symbol.iterator] === 'function';

      document.addEventListener('DOMContentLoaded', (_) => {
        txtSearch = document.querySelector('.search-form > .search-txt');
        if (fetch) {
          fetch('/blog/bloginfo.json')
            .then((data) => data.json())
            .then((jsonData) => {
              blogs = jsonData.blogs;
              console.log(blogs);
            });
          fetch('/blog/template.html').then((data) =>
            data.text().then((data) => (blogTemplate = data))
          );
        }
      });

      function addSearchResult(blogJSON) {
        if (blogTemplate === undefined) {
          setTimeout((_) => search(blogJSON), 100);
          return;
        }
        let blogHTML = blogTemplate;
        blogHTML = blogHTML
          .replace('$PATH$', `'${blogJSON.url}'`)
          .replace('$TITLE$', blogJSON.name)
          .replace('$DATE$', blogJSON.date);
        let elem = dp.parseFromString(blogHTML, 'text/xml');
        elem = elem.documentElement;
        let topicHTMLString = '<ul>';
        for (let topic of blogJSON.topics) {
          topicHTMLString += `<li>${topic}</li>`;
        }
        topicHTMLString += '</ul>';
        let topics = dp.parseFromString(topicHTMLString, 'text/xml');
        elem.append(topics.documentElement);
        if (!searchResults)
          searchResults = document.querySelector('.search-results');
        searchResults.innerHTML += elem.outerHTML;
      }

      const searchElem = (elem, searchString) =>
        elem.toLowerCase && elem.toLowerCase().includes(searchString);

      function search() {
        if (blogs === undefined) {
          setTimeout(search, 100);
          return;
        }
        let searchStrings = txtSearch.value.toLowerCase().split(' ');
        let blogMatches = new Set();
        for (let searchString of searchStrings) {
          for (let blog of blogs) {
            for (let key in blog) {
              let elem = blog[key];
              if (isIterable(elem)) {
                for (let subelem of elem) {
                  if (searchElem(subelem, searchString)) blogMatches.add(blog);
                }
              } else {
                if (searchElem(elem, searchString)) blogMatches.add(blog);
              }
            }
          }
        }
        console.log(blogMatches);
        if (searchResults) {
          searchResults.innerHTML = '';
        }
        for (let match of blogMatches) {
          addSearchResult(match);
        }
      }
    </script>
  </body>
</html>
